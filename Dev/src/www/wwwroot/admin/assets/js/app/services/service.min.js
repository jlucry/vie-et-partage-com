/*!
 * Wcms (dfide.net)
 * Copyright 2018 DFIDE
 * Licensed under dfide.net
 */

!function(){"use strict";function t(t,e,n){var a=e("xs")||e("sm"),r={search:"",FullScreen:a,Reload:null};return n.debug("FullScreen=",a),r}angular.module("app.services").factory("heads",t),t.$inject=["$rootScope","$mdMedia","$log"]}(),function(){"use strict";function t(t,e,n,a,r,o){o.then(function(t){angular.forEach(t.Menus,function(t){i.push({name:null==t.Name?"Home":t.Name,url:t.UrlMat,icon:t.IconMat,type:"link"})}),i.push()},function(t){r.debug("menu:reason=",t)});var u,i=[];return i.push(),e.$on("$locationChangeSuccess",function(){u.selectPage(void 0,t.url())}),u={version:{},sections:i,selectSection:function(t){u.openedSection=t},toggleSelectSection:function(t){u.openedSection=u.openedSection===t?null:t},isSectionSelected:function(t){return u.openedSection===t},selectPage:function(t,e){u.currentSection=t,u.currentPage=e},isPageSelected:function(t){return"#"+u.currentPage===t.url}}}angular.module("app").factory("menu",t),t.$inject=["$location","$rootScope","$http","$window","$log","siteConfData"]}(),function(){"use strict";function t(t,e){var n={ShowProgress:!0,LoadStart:function(){e.debug("[NAVS]loadStart..."),n.ShowProgress=!0},LoadEnd:function(){e.debug("[NAVS]loadEnd..."),t(function(){n.ShowProgress=!1,e.debug("[NAVS]loadEnd+++++++++++++++++++")},100)}};return n}angular.module("app.services").factory("navs",t),t.$inject=["$timeout","$log"]}(),function(){"use strict";function t(t,n,a,r,o){var u=null,i=0,e=0,l=!1,s=null,d=0,g=0,c={data:null,get:function(t){(c.data=null)!=c.onLoading&&c.onLoading(!1);a.debug("Getting post...");var e="/api/post/"+t;return a.debug("Getting post with ",e),n.get(e).then(function(t){return a.debug("Post got."),c.data=t.data,a.debug("data=",c.data),null!=c.onLoaded&&c.onLoaded(!1),c}).catch(function(t){a.error("Faile to get post: "+t.data),null!=c.onLoaded&&c.onLoaded(!1)})},post:function(t){null!=c.onLoading&&c.onLoading(!0);a.debug("Update post...");var e="/api/post?region="+o.getCurrentName()+"&type="+t;return a.debug("Update",c.data,"to",e),n.post(e,c.data).then(function(t){a.debug("Post updated, response=",t),null==t.data||""==t.data?null!=c.onError&&c.onError(!0):null!=t.data.Error?(c.data.Error=t.data.Error,null!=c.onError&&c.onError(!0)):(c.data=t.data,null!=c.onLoaded&&c.onLoaded(!0))}).catch(function(t){a.error("Failed to update post: "+t.data),null!=c.onError&&c.onError(!0)})},postFile:function(t){null!=t&&0!=t.length&&(u=t,e=i=0,l=!1,f())},removeFile:function(t){null!=t&&0!=t.length&&(s=t,g=d=0,b())},onLoading:null,onLoaded:null};return c;function f(){0==i&&null!=c.onLoading&&c.onLoading(!0);var e=u[i].file,n=u[i].type;a.debug("Upload file"+i+":",u[i],"..."),e.errorMsg=null,e.upload=r.http({url:"/file/Upload?id="+c.data.Id+"&name="+e.name+"&type="+n,data:e}),e.upload.then(function(t){a.debug("File "+e.name+" uploaded, response=",t),e.result=t.data,1==n?(c.data.Cover=t.data,a.debug("Cover uploaded to:",c.data.Cover)):2==n?(c.data.CoverCrop=t.data,a.debug("Cropped cover uploaded to:",c.data.CoverCrop)):a.debug("File uploaded to:",t.data),p(t.data)},function(t){0<t.status&&(a.error("Failed to upload file",e.name,t.status,t.data),e.errorMsg=t.status+": "+t.data,p(t.data))}),e.upload.progress(function(t){e.progress=Math.min(100,parseInt(100*t.loaded/t.total)),a.debug("File  "+e.name+"uploadprogress=",e.progress)})}function p(t){1==t.startsWith("KO")&&(e+=1,-1!=t.indexOf("refus")&&(l=!0)),i!=u.length-1?(i+=1,f()):0==e&&null!=c.onLoaded?c.onLoaded(!0):null!=c.onError&&(1==l&&(c.data.Error="Acc&egrave;s refus&eacute;!"),c.onError(!0))}function b(){0==d&&null!=c.onLoading&&c.onLoading(!0);var e=s[d],t="/api/post/"+c.data.Id+"/"+e;return a.debug("Deleting file with ",t,"..."),n.delete(t).then(function(t){a.debug("data=",c.data),0==e?(c.data.Cover="",c.data.CoverCrop="",a.debug("Cover deleted.")):a.debug("File "+e+" deleted.");v(t.data)}).catch(function(t){0<t.status&&(a.error("Failed to delete file",e,t.status,t.data),v(t.data))})}function v(t){a.debug("_removeFileNext:",t),0==t&&(g+=1),d!=s.length-1?(d+=1,b()):0==g&&null!=c.onLoaded?c.onLoaded(!0):null!=c.onError&&c.onError(!0)}}angular.module("app.posts.service").factory("post",t),t.$inject=["$rootScope","$http","$log","Upload","regions"]}(),function(){"use strict";function t(t,a,o,r,u,i){var l={settings:null,data:null,onlyValidedPost:!0,gets:function(t){(l.data=null)!=l.settings&&0<t&&(1<=t&&(o.debug("Reset post list level 1..."),l.settings.Skip=0,l.settings.Count=0,l.pagination=[]),2<=t&&o.debug("Reset post list level 2..."),3<=t&&(o.debug("Reset post list level 3..."),s("-1"),d(""),g(""),c("")));f("title",r.search),1==l.onlyValidedPost&&s("1");var e=i.getMenuFilter();o.debug("@@@@@@@@@@@@@@DefaultFilters=",e),null!=e?(null==l.settings&&(l.settings={}),l.settings.DefaultFilters=e):null==e&&null!=l.settings&&(l.settings.DefaultFilters=null);o.debug("Getting posts...");var n="/api/post/list?region="+u.getCurrentName();return o.debug("Getting posts with path=",n,", filters=",l.settings),a.post(n,l.settings).then(function(t){if(o.debug("Post got."),l.data=t.data.Posts,l.settings=t.data.Settings,o.debug("data=",l.data,"settings=",l.settings),0==l.settings.Skip&&0!=l.settings.Take&&0!=l.settings.Count){o.debug("Setting list pagination..."),l.pagination=[];var e=l.settings.Count/l.settings.Take,n=parseInt(e,10);if(NaN!=n){var a=n;e-a!=0&&(a+=1),l.lastPage=a-1;for(var r=0;r<=l.lastPage;r+=1)l.pagination.push(r);o.debug(a+" pages of posts added ("+e+","+n+").")}o.debug("pagination=",l.pagination)}return l}).catch(function(t){o.error("Faile to get posts: "+t.data)})},getSkip:function(){return l.settings.Skip},setSkip:function(t){null!=t&&0<=t&&t<=l.lastPage&&(l.settings.Skip=t,o.debug("Skip set to "+l.settings.Skip))},getTake:function(t){return l.settings.Take},setTake:function(t){l.settings.Take=t,o.debug("Take set to "+l.settings.Take)},getFilterState:function(){return e("state")},setFilterState:s,getFilterCategory:function(){return e("categorie")},setFilterCategory:d,getFilterTag:function(){return e("tag")},setFilterTag:g,getFilterGroup:function(){return e("group")},setFilterGroup:c,getFilterMine:function(){var t=e("mine");return null!=t&&"true"==t},setFilterMine:function(t){f("mine",1==t?"true":"false")},pagination:[],currentPage:function(){return null!=l.settings?l.settings.Skip:0},lastPage:-1,isFirstPage:function(){if(null!=l.settings&&0==l.settings.Skip)return!0;return!1},isCurrentPage:function(t){{if(null!=t&&null!=l.settings&&l.settings.Skip==t)return!0;if(null==l.pagination||0==l.pagination.length)return!0}return!1},isLastPage:function(){{if(null!=l.settings&&l.settings.Skip==l.lastPage)return!0;if(null==l.pagination||0==l.pagination.length)return!0}return!1}};return l;function s(t){f("state",t)}function d(t){f("categorie",t)}function g(t){f("tag",t)}function c(t){f("group",t)}function e(t){var e=null;return null!=t&&(null!=l.settings&&null!=l.settings.Filters&&(e=l.settings.Filters[t]),null!=e?o.debug("Filter("+t+")="+e):o.debug("Filter("+t+") not found!")),e}function f(t,e){null!=t&&(null!=l.settings&&null!=l.settings.Filters?(l.settings.Filters[t]=e,o.debug("Filter("+t+") set to "+e)):o.debug("Filter("+t+") not set!"))}}angular.module("app.posts.service").factory("posts",t),t.$inject=["$rootScope","$http","$log","heads","regions","siteConf"]}(),function(){"use strict";function t(t,r,o,e){var n=i(0),a={gets:function(){if(null==o||null==o.data)return null;return o.data.Regions},getById:u,getByIndex:i,getNameById:function(t){var e=u(t);if(null==e)return null;return r.debug("Region("+t+").StringValue=",e.StringValue),e.StringValue},getCurrent:function(){return n},getCurrentName:function(){if(null==n||null==n.StringValue)return"??";return n.StringValue},setCurrent:function(t){n=t}};return r.debug("regions: siteConf=",o),r.debug("regions: Current region=",a.getCurrent()),0==t.uiRouter&&(r.debug("regions: Waiting site configuration..."),e.then(function(t){n=i(0),r.debug("regions: Current region=",a.getCurrent())},function(t){})),a;function u(n){var a=null;return null==o||null==o.data||null==o.data.Regions||null==n||"0"==n?null:($.each(o.data.Regions,function(t,e){e.Id==n&&(a=e)}),r.debug("Region("+n+")=",a),a)}function i(t){if(null==o||null==o.data||null==o.data.Regions||0==o.data.Regions.length||t>o.data.Regions.length-1)return null;var e=o.data.Regions[t];return r.debug("Region["+t+"]=",e),e}}angular.module("app.services").factory("regions",t),t.$inject=["$rootScope","$log","siteConf","siteConfData"]}(),function(){"use strict";function t(n,t,a){var e=null,r=null,o=null,u=null,i={data:null,dataPromise:e,get:function(){if(null!=i.data)return a.debug("Site configuration already loaded."),i.data;return i.IsAdmin=!1,i.IsPub=!1,i.IsWriter=!1,a.debug("Getting site configuration..."),e=t.get("/api/site/configuration?region=default").then(function(t){return i.data=t.data,a.debug("Site configuration got:",i.data),1==i.haveRole("Administrator")?i.IsAdmin=!0:1==i.haveRole("Publicator")?i.IsPub=!0:1==i.haveRole("Contributor")&&(i.IsWriter=!0),i.data}).catch(function(t){a.error("Failed to get site configuration:",t.data)})},getClaimCategories:function(){var t=c();{if(null==i.data)return null;if(null==t)return i.data.Categories;if(null!=u)return u;var e=-1;u=[];for(var n=0;n<i.data.Categories.length;n++){if(-1!=e&&i.data.Categories[n].Deep>=e)u.push(i.data.Categories[n]);else if(-1!=e&&i.data.Categories[n].Deep<e)break;""+i.data.Categories[n].Id==t&&(e=i.data.Categories[n].Deep+1)}return u}},getClaimCategory:l,getClaimTags:function(){if(null==i.data)return null;return i.data.Tags},getClaimTag:s,getClaimGroups:function(){if(null==i.data)return null;return i.data.Groups},getClaimGroup:d,getMenuFilter:g,getDefaultTopCategory:c,haveRole:function(t){if(null!=t&&null!=i.data&&null!=i.data.UserRoles)for(var e=0;e<i.data.UserRoles.length;e++)if(i.data.UserRoles[e]==t)return!0;return!1},IsAdmin:!1,IsPub:!1,IsWriter:!1};return i;function l(t){if(null!=t&&null!=i.data&&null!=i.data.Categories){var e=parseInt(t,10);if(NaN!=e)for(var n=0;n<i.data.Categories.length;n++)if(i.data.Categories[n].Id==e)return a.debug("Category claim of id "+t+" = ",i.data.Categories[n]),i.data.Categories[n]}return a.debug("Category claim of id "+t+" not found!"),null}function s(t){if(null!=t&&null!=i.data&&null!=i.data.Tags){var e=parseInt(t,10);if(NaN!=e)for(var n=0;n<i.data.Tags.length;n++)if(i.data.Tags[n].Id==e)return a.debug("Tags claim of id "+t+" = ",i.data.Tags[n]),i.data.Tags[n]}return a.debug("Tags claim of id "+t+" not found!"),null}function d(t){if(null!=t&&null!=i.data&&null!=i.data.Groups){var e=parseInt(t,10);if(NaN!=e)for(var n=0;n<i.data.Groups.length;n++)if(i.data.Groups[n].Id==e)return a.debug("Groups claim of id "+t+" = ",i.data.Groups[n]),i.data.Groups[n]}return a.debug("Groups claim of id "+t+" not found!"),null}function g(){var t="#"+n.url();if(r==t)return o;if(r=t,null!=i.data&&null!=i.data.Menus)for(var e=0;e<i.data.Menus.length;e++)if(t==i.data.Menus[e].UrlMat)return o=i.data.Menus[e].DefaultFilters,u=null,o;return u=o=null,o}function c(){var t=g();if(null!=t)return t.TopCategorie}}function e(t,e){return t.debug("Return siteConf promise..."),e.get()}function n(e,n,a){return{get:function(){a.debug("Getting greeting...");var t=e.defer();return n(function(){a.debug("Got greeting."),t.resolve("Hello !")},5e3),t.promise}}}angular.module("app.services").factory("siteConf",t),t.$inject=["$location","$http","$log"],angular.module("app.services").factory("siteConfData",e),e.$inject=["$log","siteConf"],angular.module("app.services").factory("greeting",n),n.$inject=["$q","$timeout","$log"]}(),function(){"use strict";function t(t,n,a,r,o){var u=null,i=0,e=0,l=!1,s=null,d=0,g=0,c={data:null,get:function(t){(c.data=null)!=c.onLoading&&c.onLoading(!1);a.debug("Getting user...");var e="/api/user/"+t;return a.debug("Getting user with ",e),n.get(e).then(function(t){return a.debug("User got."),c.data=t.data,a.debug("data=",c.data),null!=c.onLoaded&&c.onLoaded(!1),c}).catch(function(t){a.error("Faile to get user: "+t.data),null!=c.onLoaded&&c.onLoaded(!1)})},user:function(t){null!=c.onLoading&&c.onLoading(!0);a.debug("Update user...");var e="/api/user?region="+o.getCurrentName()+"&type="+t;return a.debug("Update",c.data,"to",e),n.post(e,c.data).then(function(t){a.debug("User updated, response=",t),null==t.data||""==t.data?null!=c.onError&&c.onError(!0):null!=t.data.Error?(c.data.Error=t.data.Error,null!=c.onError&&c.onError(!0)):(c.data=t.data,null!=c.onLoaded&&c.onLoaded(!0))}).catch(function(t){a.error("Failed to update user: "+t.data),null!=c.onError&&c.onError(!0)})},postFile:function(t){null!=t&&0!=t.length&&(u=t,e=i=0,l=!1,f())},removeFile:function(t){null!=t&&0!=t.length&&(s=t,g=d=0,b())},onLoading:null,onLoaded:null};return c;function f(){0==i&&null!=c.onLoading&&c.onLoading(!0);var e=u[i].file,n=u[i].type;a.debug("Upload file"+i+":",u[i],"..."),e.errorMsg=null,e.upload=r.http({url:"/file/Upload?id="+c.data.Id+"&name="+e.name+"&type="+n,data:e}),e.upload.then(function(t){a.debug("File "+e.name+" uploaded, response=",t),e.result=t.data,1==n?(c.data.Cover=t.data,a.debug("Cover uploaded to:",c.data.Cover)):2==n?(c.data.CoverCrop=t.data,a.debug("Cropped cover uploaded to:",c.data.CoverCrop)):a.debug("File uploaded to:",t.data),p(t.data)},function(t){0<t.status&&(a.error("Failed to upload file",e.name,t.status,t.data),e.errorMsg=t.status+": "+t.data,p(t.data))}),e.upload.progress(function(t){e.progress=Math.min(100,parseInt(100*t.loaded/t.total)),a.debug("File  "+e.name+"uploadprogress=",e.progress)})}function p(t){1==t.startsWith("KO")&&(e+=1,-1!=t.indexOf("refus")&&(l=!0)),i!=u.length-1?(i+=1,f()):0==e&&null!=c.onLoaded?c.onLoaded(!0):null!=c.onError&&(1==l&&(c.data.Error="Acc&egrave;s refus&eacute;!"),c.onError(!0))}function b(){0==d&&null!=c.onLoading&&c.onLoading(!0);var e=s[d],t="/api/user/"+c.data.Id+"/"+e;return a.debug("Deleting file with ",t,"..."),n.delete(t).then(function(t){a.debug("data=",c.data),0==e?(c.data.Cover="",c.data.CoverCrop="",a.debug("Cover deleted.")):a.debug("File "+e+" deleted.");v(t.data)}).catch(function(t){0<t.status&&(a.error("Failed to delete file",e,t.status,t.data),v(t.data))})}function v(t){a.debug("_removeFileNext:",t),0==t&&(g+=1),d!=s.length-1?(d+=1,b()):0==g&&null!=c.onLoaded?c.onLoaded(!0):null!=c.onError&&c.onError(!0)}}angular.module("app.users.service").factory("user",t),t.$inject=["$rootScope","$http","$log","Upload","regions"]}(),function(){"use strict";function t(t,n,o,a,r){var u={settings:null,data:null,gets:function(t){(u.data=null)!=u.settings&&0<t&&(1<=t&&(o.debug("Reset user list level 1..."),u.settings.Skip=0,u.settings.Count=0,u.pagination=[]),2<=t&&o.debug("Reset user list level 2..."),3<=t&&(o.debug("Reset user list level 3..."),i("")));l("title",a.search),o.debug("Getting users...");var e="/api/user/list?region="+r.getCurrentName();return o.debug("Getting users with path=",e," and filters=",u.settings),n.post(e,u.settings).then(function(t){if(o.debug("users got."),u.data=t.data.Users,u.settings=t.data.Settings,o.debug("data=",u.data,"settings=",u.settings),0==u.settings.Skip&&0!=u.settings.Take&&0!=u.settings.Count){o.debug("Setting list pagination..."),u.pagination=[];var e=u.settings.Count/u.settings.Take,n=parseInt(e,10);if(NaN!=n){var a=n;e-a!=0&&(a+=1),u.lastPage=a-1;for(var r=0;r<=u.lastPage;r+=1)u.pagination.push(r);o.debug(a+" pages of users added ("+e+","+n+").")}o.debug("pagination=",u.pagination)}return u}).catch(function(t){o.error("Faile to get users: "+t.data)})},getSkip:function(){return u.settings.Skip},setSkip:function(t){null!=t&&0<=t&&t<=u.lastPage&&(u.settings.Skip=t,o.debug("Skip set to "+u.settings.Skip))},getTake:function(t){return u.settings.Take},setTake:function(t){u.settings.Take=t,o.debug("Take set to "+u.settings.Take)},getFilterGroup:function(){return function(t){var e=null;null!=t&&(null!=u.settings&&null!=u.settings.Filters&&(e=u.settings.Filters[t]),null!=e?o.debug("Filter("+t+")="+e):o.debug("Filter("+t+") not found!"));return e}("group")},setFilterGroup:i,pagination:[],currentPage:function(){return null!=u.settings?u.settings.Skip:0},lastPage:-1,isFirstPage:function(){if(null!=u.settings&&0==u.settings.Skip)return!0;return!1},isCurrentPage:function(t){{if(null!=t&&null!=u.settings&&u.settings.Skip==t)return!0;if(null==u.pagination||0==u.pagination.length)return!0}return!1},isLastPage:function(){{if(null!=u.settings&&u.settings.Skip==u.lastPage)return!0;if(null==u.pagination||0==u.pagination.length)return!0}return!1}};return u;function i(t){l("group",t)}function l(t,e){null!=t&&(null!=u.settings&&null!=u.settings.Filters?(u.settings.Filters[t]=e,o.debug("Filter("+t+") set to "+e)):o.debug("Filter("+t+") not set!"))}}angular.module("app.users.service").factory("users",t),t.$inject=["$rootScope","$http","$log","heads","regions"]}();